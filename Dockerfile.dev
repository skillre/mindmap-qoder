# 开发环境Dockerfile

FROM node:16-alpine

# 安装开发工具
RUN apk add --no-cache git nginx

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY web/package*.json ./web/
COPY simple-mind-map/package*.json ./simple-mind-map/
COPY server/package*.json ./server/

# 安装所有依赖（包括开发依赖）
RUN cd web && npm install
RUN cd simple-mind-map && npm install  
RUN cd server && npm install

# 复制源代码
COPY . .

# 复制nginx配置
COPY nginx.dev.conf /etc/nginx/nginx.conf

# 创建启动脚本
RUN echo '#!/bin/sh' > /start-dev.sh && \
    echo 'echo "Starting backend server in development mode..."' >> /start-dev.sh && \
    echo 'cd /app/server && npm run dev &' >> /start-dev.sh && \
    echo 'echo "Starting frontend development server..."' >> /start-dev.sh && \
    echo 'cd /app/web && npm run serve &' >> /start-dev.sh && \
    echo 'echo "Starting nginx..."' >> /start-dev.sh && \
    echo 'nginx -g "daemon off;"' >> /start-dev.sh && \
    chmod +x /start-dev.sh

# 设置环境变量
ENV NODE_ENV=development
ENV PORT=3000

# 暴露端口
EXPOSE 80 3000 8080

# 启动开发服务
CMD ["/start-dev.sh"]